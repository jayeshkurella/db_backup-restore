pipeline {
    agent any

    environment {
        WORKSPACE_DIR = "${WORKSPACE}/Chhaya_new_backend"
        VIRTUALENV_DIR = "${WORKSPACE}/.venv"
        PYTHON = 'python3'
        DB_HOST = 'localhost'
        DB_PORT = '5432'
        DB_NAME = 'chhaya_demo'
        DB_USER = 'postgres'
        DB_PASSWORD = 'postgres'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the code from GitLab repository using stored credentials
                    git credentialsId: 'gitlab-jenkins', url: 'https://gitlab.com/coderizers/app_view/chhaya_foundation.git', branch: 'sanketlodhe'
                }
            }
        }

        stage('Set up Python Environment') {
            steps {
                script {
                    // Install the python3-venv package if not already installed
                    sh 'sudo apt-get update && sudo apt-get install -y python3-venv'

                    // Create a virtual environment
                    sh 'python3 -m venv ${VIRTUALENV_DIR}'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    // Install dependencies using pip from requirements.txt
                    sh './${VIRTUALENV_DIR}/bin/pip install -r ${WORKSPACE_DIR}/requirement.txt'
                }
            }
        }

        stage('Set up Database') {
            steps {
                script {
                    // Install PostgreSQL client (or MySQL client if using MySQL)
                    sh 'sudo apt-get install -y postgresql-client'
                    
                    // Optionally, create the database if it doesn't exist
                    sh """
                        PGPASSWORD=${DB_PASSWORD} psql -h ${DB_HOST} -U ${DB_USER} -d postgres -c "CREATE DATABASE IF NOT EXISTS ${DB_NAME};"
                    """
                }
            }
        }

        stage('Run Migrations') {
            steps {
                script {
                    // Run Django migrations (or similar for your framework)
                    sh './${VIRTUALENV_DIR}/bin/python ${WORKSPACE_DIR}/manage.py migrate --noinput'
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Deploy the application in the background
                    echo 'Deploying the application...'
                    // Run the application (e.g., Django or Flask) in the background
                    sh 'nohup ./${VIRTUALENV_DIR}/bin/python ${WORKSPACE_DIR}/manage.py runserver 0.0.0.0:9000 &'
                }
            }
        }
    }

    post {
        always {
            // Cleanup the virtual environment after deployment
            echo 'Cleaning up...'
            sh 'rm -rf ${VIRTUALENV_DIR}'
        }

        success {
            echo 'Build and Deployment Successful!'
        }

        failure {
            echo 'Build or Deployment Failed!'
        }
    }
}
