<div class="d-flex-container">
  <div class="container-fluid mt-2">
    <h2 class="text-center p-2 text-white bg-primary">Missing Person Search</h2>

    <div class="form-group">
      <label for="fullName">Enter Full Name</label>
      <input type="text" class="form-control" id="fullName" [(ngModel)]="fullName" placeholder="Enter full name" />
    </div>

    <button class="btn btn-primary w-100 mt-3" (click)="search()" [disabled]="loading">
      Search
    </button>

    <div *ngIf="loading" class="mt-3 text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <div *ngIf="errorMessage" class="mt-3 text-danger text-center">{{ errorMessage }}</div>

    <div *ngIf="!loading && searchResults" class="mt-4">
      <!-- Tabs -->
      <ul class="nav nav-tabs" id="matchTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active" id="newlyMatchedTab" data-bs-toggle="tab" href="#newlyMatched" role="tab"
            aria-controls="newlyMatched" aria-selected="true">Newly Matched</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="previouslyMatchedTab" data-bs-toggle="tab" href="#previouslyMatched" role="tab"
            aria-controls="previouslyMatched" aria-selected="false">Previously Matched</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="previouslyRejectedTab" data-bs-toggle="tab" href="#previouslyRejected" role="tab"
            aria-controls="previouslyRejected" aria-selected="false">Previously Rejected</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="confirmedMatchedTab" data-bs-toggle="tab" href="#confirmedMatched" role="tab"
            aria-controls="confirmedMatched" aria-selected="false">Confirmed Matches</a>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="matchTabsContent">
        <!-- Newly Matched Section -->
        <div class="tab-pane fade show active" id="newlyMatched" role="tabpanel" aria-labelledby="newlyMatchedTab">
          <div *ngIf="searchResults.newly_matched !== 'No newly matched persons found.'">
            <div class="row">
              <div *ngFor="let match of searchResults.newly_matched; let i = index" class="col-md-4">
                <div class="card border-primary mb-3 mt-2" 
                     style="max-width: 100%;" 
                     [ngStyle]="{'--delay': (i * 0.5) + 's'}"> <!-- Apply delay dynamically -->
                  <div class="card-header">
                    Match ID: {{ match.match_id }}
                  </div>
                  <div class="px-3 py-2 border-bottom">
                    <strong>Previously Attempted Count:</strong> {{ searchResults.rematch_attempt }}
                  </div>
                  <div class="card-body d-flex">
                    <!-- Left Column: Missing Person -->
                    <div class="w-50 pe-3">
                      <h6 class="card-title">Missing Person</h6>
                      <p class="card-text mb-1"><strong>Name:</strong> {{ searchResults.missing_person.full_name }}</p>
                      <p class="card-text mb-1"><strong>Age:</strong> {{ searchResults.missing_person.age }}</p>
                    </div>
                    <!-- Right Column: Matched Entity -->
                    <div class="w-50 ps-3">
                      <h6 class="card-title">{{ match.matched_entity.address.type }}</h6>
                      <p class="card-text mb-1"><strong>Name:</strong> {{ match.matched_entity.full_name }}</p>
                      <p class="card-text mb-1"><strong>Age:</strong> {{ match.matched_entity.estimated_age }}</p>
                    </div>
                  </div>
                  <div class="card-footer d-flex justify-content-between">
                    <!-- <button class="btn btn-success btn-sm" (click)="confirmMatch(match)">Confirm match</button> -->
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewDetailsModal" (click)="viewDetails(match)">View Details </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="searchResults.newly_matched === 'No newly matched persons found.'">
            <p class="text-muted">{{ searchResults.newly_matched }}</p>
          </div>
        </div>

        <!-- Previously Matched Section -->
        <div class="tab-pane fade" id="previouslyMatched" role="tabpanel" aria-labelledby="previouslyMatchedTab">
          <div
            *ngIf="searchResults?.previously_matched && searchResults.previously_matched.length > 0; else noPreviouslyMatched">
            <div class="row">
              <div *ngFor="let match of searchResults.previously_matched; let i = index" class="col-md-4">
                <div class="card border-success mb-3 mt-2" style="max-width: 100%;" [ngStyle]="{'--delay': (i * 0.5) + 's'}"> 
                  <div class="card-header">
                    Match ID: {{ match.match_id }}
                  </div>
                  <div class="px-3 py-2 border-bottom">
                    <strong>Previously Attempted Count:</strong> {{ searchResults.rematch_attempt }}
                  </div>
                  <div class="card-body d-flex flex-column">
                    <div class="d-flex">
                      <!-- Left Column: Missing Person -->
                      <div class="w-50 pe-3">
                        <h6 class="card-title">Missing Person</h6>
                        <p class="card-text mb-1"><strong>Name:</strong> {{ searchResults.missing_person?.full_name }}</p>
                        <p class="card-text mb-1"><strong>Age:</strong> {{ searchResults.missing_person?.age }}</p>
                      </div>
                      <!-- Right Column: Matched Entity -->
                      <div class="w-50 ps-3">
                        <h6 class="card-title">{{ match.matched_entity?.address?.type }}</h6>
                        <p class="card-text mb-1"><strong>Name:</strong> {{ match.matched_entity?.full_name }}</p>
                        <p class="card-text mb-1"><strong>Age:</strong> {{ match.matched_entity?.estimated_age }}</p>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewDetailsModal" (click)="viewDetails(match)">View Details</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #noPreviouslyMatched>
            <p class="text-muted">No previously matched records found.</p>
          </ng-template>
        </div>
        
        <!-- Previously Rejected Section -->
        <div class="tab-pane fade" id="previouslyRejected" role="tabpanel" aria-labelledby="previouslyRejectedTab">
          <div *ngIf="searchResults?.previously_rejected?.length > 0; else noPreviouslyRejected">
            <div class="row">
              <div *ngFor="let rejected of searchResults.previously_rejected; let i = index" class="col-md-4">
                <div class="card border-danger mb-3 mt-2" style="max-width: 100%;" [ngStyle]="{'--delay': (i * 0.5) + 's'}">
                  <div class="card-header">
                    Match ID: {{ rejected.match_id }}
                  </div>
                  <div class="px-3 py-2 border-bottom">
                    <strong>Previously Attempted Count:</strong> {{ searchResults.rematch_attempt }}
                  </div>
                  <div class="card-body d-flex flex-column">
                    <div class="d-flex">
                      <div class="w-50 pe-3">
                        <h6 class="card-title">Rejected Entity</h6>
                        <p class="card-text mb-1"><strong>Matched With:</strong> {{ rejected?.Matched_With }}</p>
                        <p class="card-text mb-1"><strong>Name:</strong> {{ rejected?.name }}</p>
                        <p class="card-text mb-1"><strong>Match Percentage:</strong> {{ rejected?.match_percentage }}%</p>
                      </div>
                      <div class="w-50 ps-3">
                        <h6 class="card-title">Rejection Details</h6>
                        <p class="card-text mb-1"><strong>Rejection Reason:</strong> {{ rejected?.rejection_reason || 'Not provided' }}</p>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer d-flex justify-content-between">
                    <!-- Unreject button -->
                    <button class="btn btn-warning btn-sm" (click)="unrejectMatch(rejected.missing_person_details?.unique_id, rejected.match_id)">
                      Unreject Match
                    </button>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewDetailsModal" (click)="viewDetails(rejected)">View Details</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        
          <!-- The ng-template is correctly placed here for fallback -->
          <ng-template #noPreviouslyRejected>
            <p class="text-muted">No previously rejected persons found.</p>
          </ng-template>
        </div>

        <!-- matched  -->
        <div class="tab-pane fade" id="confirmedMatched" role="tabpanel" aria-labelledby="confirmedMatchedTab">
          <div *ngIf="searchResults?.confirmed_matched?.length > 0; else noConfirmedMatches">
            <div class="row">
              <div *ngFor="let match of searchResults.confirmed_matched; let i = index" class="col-md-4">
                <div class="card border-success mb-3 mt-2" style="max-width: 100%;" [ngStyle]="{'--delay': (i * 0.5) + 's'}">
                  <div class="card-header">
                    Match ID: {{ match.match_id }}
                  </div>
                  <div class="px-3 py-2 border-bottom">
                    <strong>Match Percentage:</strong> {{ match.match_percentage }}%
                  </div>
                  <div class="card-body d-flex">
                    <!-- Left Column: Missing Person -->
                    <div class="w-50 pe-3">
                      <h6 class="card-title">Missing Person</h6>
                      <p class="card-text mb-1"><strong>Name:</strong> {{ searchResults.missing_person.full_name }}</p>
                      <p class="card-text mb-1"><strong>Age:</strong> {{ searchResults.missing_person.age }}</p>
                    </div>
                    <!-- Right Column: Matched Entity -->
                    <div class="w-50 ps-3">
                      <h6 class="card-title">Matched Entity</h6>
                      <p class="card-text mb-1"><strong>Name:</strong> {{ match.matched_entity.full_name }}</p>
                      <p class="card-text mb-1"><strong>Age:</strong> {{ match.matched_entity.estimated_age }}</p>
                    </div>
                  </div>
                  <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewDetailsModal" (click)="viewDetails(match)">View Details</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Fallback message if no confirmed matches -->
          <ng-template #noConfirmedMatches>
            <p class="text-muted">No confirmed matches found.</p>
          </ng-template>
        </div>
        
      </div>
    </div>
  </div>
</div>


<!-- Modal Structure -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewDetailsModalLabel">Match Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="selectedMatch" class="row">
          <!-- Missing Person Details -->
          <div class="col-md-6 border-end">
            <h6 class="text-primary">Missing Person</h6>
            <img
              [src]="selectedMatch?.missing_person?.photo_upload ? (environment.apiUrl + selectedMatch.missing_person.photo_upload) : 'assets/images/pngwing.com.png'"
              alt="Missing Person Photo"
              class="img-fluid rounded mb-3"
              style="max-height: 200px; object-fit: cover;"
            />
            <!-- Table with Missing Person Details -->
            <table class="table table-bordered">
              <tbody>
                <tr>
                  <td><strong>Name:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.full_name }}</td>
                </tr>
                <tr>
                  <td><strong>Age:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.age }}</td>
                </tr>
                <tr>
                  <td><strong>Blood Group:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.blood_group }}</td>
                </tr>
                <tr>
                  <td><strong>Condition:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.condition }}</td>
                </tr>
                <tr>
                  <td><strong>Last Known Address:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.address?.full_address }}</td>
                </tr>
                <tr>
                  <td><strong>Contact:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.contact?.phone_number }}</td>
                </tr>
                <tr>
                  <td><strong>Last Seen:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.last_seen_location }}</td>
                </tr>
                <tr>
                  <td><strong>Reporting Person:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.reportingperson_name }}</td>
                </tr>
                <tr>
                  <td><strong>Case Status:</strong></td>
                  <td>{{ selectedMatch?.missing_person?.case_status }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Matched Entity Details -->
          <div class="col-md-6">
            <h6 class="text-success">Matched Entity</h6>
            <img
              [src]="selectedMatch?.matched_entity?.photo_upload ? (environment.apiUrl + selectedMatch.matched_entity.photo_upload) : 'assets/images/pngwing.com.png'"
              alt="Matched Entity Photo"
              class="img-fluid rounded mb-3"
              style="max-height: 200px; object-fit: cover;"
            />
            <!-- Table with Matched Entity Details -->
            <table class="table table-bordered">
              <tbody>
                <tr>
                  <td><strong>Name:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.full_name }}</td>
                </tr>
                <tr>
                  <td><strong>Estimated Age:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.estimated_age }}</td>
                  <td>{{ selectedMatch?.previously_rejected?.estimated_age }}</td>
                </tr>
                <tr>
                  <td><strong>Blood Group:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.blood_group }}</td>
                </tr>
                <tr>
                  <td><strong>Condition:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.condition }}</td>
                </tr>
                <tr>
                  <td><strong>Address:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.address?.full_address }}</td>
                </tr>
                <tr>
                  <td><strong>Contact:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.contact?.phone_number }}</td>
                </tr>
                <tr>
                  <td><strong>Last Seen:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.last_seen_location }}</td>
                </tr>
                <tr>
                  <td><strong>Case Status:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.case_status }}</td>
                </tr>
                <tr>
                  <td><strong>Police Station:</strong></td>
                  <td>{{ selectedMatch?.matched_entity?.police_station_name_and_address?.name }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="openRejectModal()">Reject Match</button>
        <button type="button" class="btn btn-success" (click)="openConfirmationModal(selectedMatch)">Confirm Match</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Nested Modal for Rejection Reason -->
<div class="modal fade" id="rejectMatchModal" tabindex="-1" aria-labelledby="rejectMatchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectMatchModalLabel">Reject Match</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="submitRejection()">
          <div class="form-group">
            <label for="rejectionReason">Rejection Reason</label>
            <textarea class="form-control" id="rejectionReason" [(ngModel)]="rejectionReason" name="rejectionReason" required></textarea>
          </div>
          <div class="form-group mt-3">
            <button type="submit" class="btn btn-danger">Submit Rejection</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- nested modal for confirmed match -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Match Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="confirmMatchForm" (ngSubmit)="confirmMatch()">
          <div class="mb-3">
            <label for="confirmed_by_name" class="form-label">Confirmed By (Name)</label>
            <input id="confirmed_by_name" formControlName="confirmed_by_name" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="confirmed_by_relationship" class="form-label">Relationship with Victim</label>
            <input id="confirmed_by_relationship" formControlName="confirmed_by_relationship" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="confirmed_by_contact" class="form-label">Contact Number</label>
            <input id="confirmed_by_contact" formControlName="confirmed_by_contact" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="notes" class="form-label">Notes</label>
            <textarea id="notes" formControlName="notes" class="form-control"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" [disabled]="confirmMatchForm.invalid">Confirm Match</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


