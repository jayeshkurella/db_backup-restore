pipeline {
    agent any

    triggers {
        cron('H 2 * * *')   // Runs daily around 2AM
    }

    environment {
        GIT_REPO       = "https://github.com/jayeshkurella/db_backup-restore.git"
        BRANCH         = "master"
        UPLOAD_DIR     = "/var/lib/jenkins/workspace/backup/upload-backup"
        BACKUP_DIR     = "/var/lib/jenkins/workspace/backup/Local-DB-Backups"
        FINAL_DIR      = "/var/lib/jenkins/workspace/backup/final-zip"
        SCRIPT_DIR     = "scripts"
        DB_USER        = "postgres"
        DB_PASSWORD    = "postgres"
        DB_HOST        = "localhost"
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo "Cloning repository..."
                git url: "${GIT_REPO}", branch: "${BRANCH}"
            }
        }

        stage('Run Health Check') {
            steps {
                echo "Running health checks..."
                sh """
                    chmod +x ${SCRIPT_DIR}/health-check.sh
                    DB_USER=${DB_USER} DB_PASSWORD=${DB_PASSWORD} DB_HOST=${DB_HOST} ./${SCRIPT_DIR}/health-check.sh
                """
            }
        }

        stage('Database Backup') {
            steps {
                echo "Running DB backup..."
                sh """
                    chmod +x ${SCRIPT_DIR}/db-backup.sh
                    DB_USER=${DB_USER} DB_PASSWORD=${DB_PASSWORD} DB_HOST=${DB_HOST} BACKUP_DIR=${BACKUP_DIR} LOG_FILE=${BACKUP_DIR}/backup_log.txt ./${SCRIPT_DIR}/db-backup.sh
                """
            }
        }

        stage('Upload Backup Files') {
            steps {
                echo "Uploading backup files..."
                sh """
                    mkdir -p ${UPLOAD_DIR}
                    cp -r ${BACKUP_DIR}/* ${UPLOAD_DIR}/
                """
            }
        }

        stage('Verify Backups (Checksum)') {
            steps {
                echo "Verifying backups..."
                sh """
                    chmod +x ${SCRIPT_DIR}/checksum.sh

                    for file in \$(find ${UPLOAD_DIR} -type f -name "*.gz"); do
                        ${SCRIPT_DIR}/checksum.sh "\$file"
                    done
                """
            }
        }

        stage('Create Single ZIP Archive') {
            steps {
                echo "Creating consolidated ZIP file..."
                sh """
                    mkdir -p ${FINAL_DIR}

                    TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
                    FINAL_ZIP=${FINAL_DIR}/all_databases_backup_\${TIMESTAMP}.zip

                    zip -r \${FINAL_ZIP} ${UPLOAD_DIR}

                    echo "ZIP created at: \${FINAL_ZIP}"
                """
            }
        }

    }

    post {
        success {
            echo "✅ BACKUP PIPELINE SUCCESSFUL"
        }
        failure {
            echo "❌ BACKUP PIPELINE FAILED"
        }
    }
}
